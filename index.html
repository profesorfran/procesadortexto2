<script>
  // === CONFIG ===
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyVU8Sn7KQ_52m19F4DrhTukog1xI3gbgwNTVM2bsfprzI_hBCca36IbWZN0E1EwKk6/exec";

  // === DOM refs ===
  const textarea = document.getElementById("texto");
  const contador = document.getElementById("contador");
  const mensaje  = document.getElementById("mensaje");
  const btn      = document.getElementById("btnEnviar") || document.querySelector("button");

  // --- Contador ---
  textarea.addEventListener("input", () => {
    const v = textarea.value.trim();
    contador.innerText = (v ? v.split(/\s+/).filter(Boolean).length : 0) + " palabras";
  });

  // --- Bloqueo atajos copiar/pegar/cortar/seleccionar ---
  textarea.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && ['v','c','x','a'].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });

  // --- BLOQUEO TOTAL DE DRAG & DROP (página y textarea) + arrastre interno ---
  const bloqueaDND = (el) => {
    ["dragenter","dragover","dragleave","drop"].forEach(ev => {
      el.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation(); return false;
      }, { passive: false, capture: true });
    });
  };
  bloqueaDND(window); bloqueaDND(document); bloqueaDND(document.documentElement);
  bloqueaDND(document.body); bloqueaDND(textarea);
  textarea.setAttribute("ondrop","return false");
  textarea.setAttribute("ondragover","return false");
  textarea.setAttribute('draggable', 'false');
  textarea.addEventListener('dragstart', (e) => { e.preventDefault(); }, { passive: false });
  textarea.addEventListener('beforeinput', (e) => {
    if (e.inputType === 'insertFromDrop') e.preventDefault();
  });

  // --- BORRADO INMEDIATO AL SALIR / CAMBIAR DE PESTAÑA/APP (ROBUSTO) ---
  function borrarTexto() {
    textarea.value = "";
    contador.innerText = "0 palabras";
    try { localStorage.removeItem("procesador_borrador"); } catch(_) {}
  }

  // 1) Eventos estándar y de compatibilidad
  const wipe = () => borrarTexto();

  // Cambia visibilidad (tabs/app) — estándar
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState !== "visible") wipe();
  }, { capture: true });

  // Prefijo WebKit (por si algún iOS viejo)
  document.addEventListener("webkitvisibilitychange", () => {
    // @ts-ignore
    if (document.webkitVisibilityState && document.webkitVisibilityState !== "visible") wipe();
  }, { capture: true });

  // Pierde foco de ventana (selector de pestañas / app switcher)
  window.addEventListener("blur", wipe, { capture: true });

  // iOS/Safari: pasa a segundo plano o usa BFCache
  window.addEventListener("pagehide", wipe, { capture: true });

  // Cerrar o recargar (incluye pull-to-refresh)
  window.addEventListener("beforeunload", wipe);

  // Page Lifecycle (Chrome móviles: freeze)
  document.addEventListener("freeze", wipe, { capture: true });

  // 2) Watchdog: por si algún navegador no dispara eventos a tiempo
  //    Si la página no está visible o el documento no tiene foco -> borrar.
  let watchdogTimer = null;
  const startWatchdog = () => {
    if (watchdogTimer) return;
    watchdogTimer = setInterval(() => {
      const visible = document.visibilityState === "visible";
      const focused = document.hasFocus && document.hasFocus();
      if (!visible || !focused) wipe();
    }, 200);
  };
  const stopWatchdog = () => { if (watchdogTimer) { clearInterval(watchdogTimer); watchdogTimer = null; } };
  // Arranca el watchdog al cargar
  startWatchdog();

  // --- Envío al Apps Script ---
  async function enviarTexto() {
    mensaje.textContent = "";
    mensaje.classList.remove("error");

    const nombre    = document.getElementById("nombre").value.trim();
    const apellidos = document.getElementById("apellidos").value.trim();
    const curso     = document.getElementById("curso").value.trim();
    const texto     = textarea.value.trim();

    if (!nombre || !apellidos || !curso || !texto) {
      alert("Por favor, rellena todos los campos antes de enviar.");
      return;
    }

    const params = new URLSearchParams({ nombre, apellidos, curso, texto });
    if (btn) btn.disabled = true;

    try {
      const resp = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params.toString()
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data || !data.ok) throw new Error((data && data.error) || "Error en el servidor");

      mensaje.innerHTML = `✅ Guardado en Drive como <b>${data.fileName}</b>. ` +
                          `<a href="${data.fileUrl}" target="_blank" rel="noopener">Abrir</a>`;

      // Limpieza total tras éxito
      document.getElementById("nombre").value = "";
      document.getElementById("apellidos").value = "";
      document.getElementById("curso").value = "";
      wipe();
    } catch (e) {
      mensaje.textContent = "❌ No se pudo enviar. Revisa el WebApp o la conexión.";
      mensaje.classList.add("error");
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  // Exponer función al botón
  window.enviarTexto = enviarTexto;
</script>
