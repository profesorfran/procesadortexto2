<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Procesador de Texto</title>
  <style>
    html, body { overscroll-behavior-y: contain; } /* evita pull-to-refresh accidental */
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    input, textarea { width: 100%; font-size: 16px; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
    textarea { height: 220px; resize: vertical; overflow-y: auto; user-select: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; }
    button { width: 100%; padding: 12px; font-size: 16px; }
    #contador { text-align: right; font-size: 14px; color: #333; }
    .autor { font-size: 14px; text-align: center; color: #666; margin-bottom: 20px; }
    .mensaje { font-size: 16px; color: green; text-align: center; margin-top: 10px; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h2>Procesador de Texto</h2>
  <div class="autor">Desarrollado por Francisco David Sánchez Valencia</div>

  <p style="color: red; text-align: center; font-weight: bold; margin-top: 10px;">
    ATENCIÓN: no se permite copiar/pegar. Si cambias de pestaña, se guardará un borrador local para no perder tu texto.
  </p>

  <input type="text" id="nombre" placeholder="Nombre" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
         onpaste="return false;" oncopy="return false;" oncut="return false;" oncontextmenu="return false;">
  <input type="text" id="apellidos" placeholder="Apellidos" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
         onpaste="return false;" oncopy="return false;" oncut="return false;" oncontextmenu="return false;">
  <input type="text" id="curso" placeholder="Curso" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
         onpaste="return false;" oncopy="return false;" oncut="return false;" oncontextmenu="return false;">
  <textarea id="texto" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
            onpaste="return false;" oncopy="return false;" oncut="return false;" oncontextmenu="return false;"
            placeholder="Escribe tu texto aquí…"></textarea>

  <div id="contador">0 palabras</div>
  <button id="btnEnviar" onclick="enviarTexto()">Enviar</button>
  <div class="mensaje" id="mensaje"></div>

  <script>
    // === CONFIG ===
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyVU8Sn7KQ_52m19F4DrhTukog1xI3gbgwNTVM2bsfprzI_hBCca36IbWZN0E1EwKk6/exec"; // tu exec

    // === DOM refs ===
    const textarea = document.getElementById("texto");
    const contador = document.getElementById("contador");
    const mensaje  = document.getElementById("mensaje");
    const btn      = document.getElementById("btnEnviar");

    // === Autosave local ===
    const STORAGE_KEY = "procesador_borrador";
    // Restaura borrador si existe
    (function restore() {
      const draft = localStorage.getItem(STORAGE_KEY);
      if (draft) {
        textarea.value = draft;
        contador.innerText = (draft.trim() ? draft.trim().split(/\s+/).length : 0) + " palabras";
      }
    })();

    // Contador y guardado continuo del borrador
    textarea.addEventListener("input", () => {
      const v = textarea.value;
      const palabras = v.trim() ? v.trim().split(/\s+/).filter(Boolean).length : 0;
      contador.innerText = palabras + " palabras";
      localStorage.setItem(STORAGE_KEY, v);
    });

    // Bloqueo de atajos copiar/pegar/cortar/seleccionar
    textarea.addEventListener("keydown", function(e) {
      if ((e.ctrlKey || e.metaKey) && ['v','c','x','a'].includes(e.key.toLowerCase())) e.preventDefault();
    });

    // En vez de borrar al perder foco, guardamos borrador
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") localStorage.setItem(STORAGE_KEY, textarea.value);
    });

    async function enviarTexto() {
      // Limpia mensaje
      mensaje.textContent = "";
      mensaje.classList.remove("error");

      const nombre    = document.getElementById("nombre").value.trim();
      const apellidos = document.getElementById("apellidos").value.trim();
      const curso     = document.getElementById("curso").value.trim();
      const texto     = textarea.value.trim();

      if (!nombre || !apellidos || !curso || !texto) {
        alert("Por favor, rellena todos los campos antes de enviar.");
        return;
      }

      // Prepara envío
      const params = new URLSearchParams({ nombre, apellidos, curso, texto });

      btn.disabled = true;

      try {
        const resp = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params.toString()
        });

        // Intentamos JSON (según Apps Script propuesto)
        const data = await resp.json().catch(() => null);

        if (!resp.ok || !data || !data.ok) {
          throw new Error((data && data.error) || "Error en el servidor");
        }

        // OK: mostramos nombre real del archivo y enlace
        mensaje.innerHTML = `✅ Guardado en Drive como <b>${data.fileName}</b>. ` +
                            `<a href="${data.fileUrl}" target="_blank" rel="noopener">Abrir</a>`;

        // Limpieza y borrado de borrador
        document.getElementById("nombre").value = "";
        document.getElementById("apellidos").value = "";
        document.getElementById("curso").value = "";
        textarea.value = "";
        contador.innerText = "0 palabras";
        localStorage.removeItem(STORAGE_KEY);

      } catch (err) {
        mensaje.textContent = "❌ No se pudo enviar. Revisa que el WebApp esté desplegado y accesible.";
        mensaje.classList.add("error");
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
