<script>
  // === CONFIG ===
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyVU8Sn7KQ_52m19F4DrhTukog1xI3gbgwNTVM2bsfprzI_hBCca36IbWZN0E1EwKk6/exec";

  // === DOM refs ===
  const textarea = document.getElementById("texto");
  const contador = document.getElementById("contador");
  const mensaje  = document.getElementById("mensaje");
  const btn      = document.querySelector("button");

  // --- Contador ---
  textarea.addEventListener("input", () => {
    const v = textarea.value.trim();
    contador.innerText = (v ? v.split(/\s+/).filter(Boolean).length : 0) + " palabras";
  });

  // --- Bloqueo copiar/pegar/cortar/seleccionar (atajos) ---
  textarea.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && ['v','c','x','a'].includes(e.key.toLowerCase())) {
      e.preventDefault();
    }
  });

  // --- BLOQUEO TOTAL DE DRAG & DROP (página y textarea) ---
  const bloqueaDND = (el) => {
    ["dragenter","dragover","dragleave","drop"].forEach(ev => {
      el.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }, { passive: false, capture: true });
    });
  };
  bloqueaDND(window);
  bloqueaDND(document);
  bloqueaDND(document.documentElement);
  bloqueaDND(document.body);
  bloqueaDND(textarea);
  // Extra: evita que el navegador muestre “soltar para pegar”
  textarea.setAttribute("ondrop","return false");
  textarea.setAttribute("ondragover","return false");

  // --- BORRADO INMEDIATO AL SALIR / CAMBIAR DE PESTAÑA/APP ---
  function borrarTexto() {
    textarea.value = "";
    contador.innerText = "0 palabras";
    // Por si existiera algún autosave residual:
    try { localStorage.removeItem("procesador_borrador"); } catch(_) {}
  }

  // Android/Chrome e iOS/Safari: cubrimos todos los casos sin gracia
  document.addEventListener("visibilitychange", () => {
    // visible -> ok; cualquier otro estado -> borrar YA
    if (document.visibilityState !== "visible") borrarTexto();
  });
  // Pasa a segundo plano, navegas atrás/adelante o iOS usa BFCache
  window.addEventListener("pagehide", borrarTexto, { capture: true });
  // Pierde foco de ventana (App Switcher, selector de pestañas, etc.)
  window.addEventListener("blur", borrarTexto);
  // Cerrar o recargar (incluye pull-to-refresh)
  window.addEventListener("beforeunload", borrarTexto);
  // Page Lifecycle (algunas Chrome): congelación
  document.addEventListener("freeze", borrarTexto);

  // --- Envío al Apps Script ---
  async function enviarTexto() {
    mensaje.textContent = "";

    const nombre    = document.getElementById("nombre").value.trim();
    const apellidos = document.getElementById("apellidos").value.trim();
    const curso     = document.getElementById("curso").value.trim();
    const texto     = textarea.value.trim();

    if (!nombre || !apellidos || !curso || !texto) {
      alert("Por favor, rellena todos los campos antes de enviar.");
      return;
    }

    const params = new URLSearchParams({ nombre, apellidos, curso, texto });
    btn.disabled = true;

    try {
      const resp = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params.toString()
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data || !data.ok) throw new Error((data && data.error) || "Error en el servidor");

      mensaje.innerHTML = `✅ Guardado en Drive como <b>${data.fileName}</b>. ` +
                          `<a href="${data.fileUrl}" target="_blank" rel="noopener">Abrir</a>`;

      // Limpieza total tras éxito
      document.getElementById("nombre").value = "";
      document.getElementById("apellidos").value = "";
      document.getElementById("curso").value = "";
      borrarTexto();
    } catch (e) {
      mensaje.textContent = "❌ No se pudo enviar. Revisa el WebApp o la conexión.";
      mensaje.classList.add("error");
    } finally {
      btn.disabled = false;
    }
  }

  // Exponer para el botón
  window.enviarTexto = enviarTexto;
</script>
  
